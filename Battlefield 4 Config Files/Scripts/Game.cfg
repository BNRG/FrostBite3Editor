#!/bin/lua

core = require "Frost.Core"

log:debug("Parsing 'Game.cfg' settings")

local function applySettings(settings)
	core.parseKeyValueCfgString(settings, _G)
end

local function append(table, value)
	table[#table+1] = value
end

--
-- Note that this is now actually a Lua script (signified by the first line
-- of this file), to allow conditionals and more advanced settings processing
--
-- There are two ways to set settings. One is by editing the key-value string
-- block below, the other is to actually use Lua code to set settings.
--


applySettings [=[

#Enable performance tracker
PerformanceTracker.Enabled false

Game.Level Levels/Frontend/Frontend
#Game.DefaultLayerInclusion GameMode=ConquestLarge
#Game.StartPoint E3_Demo

Server.DebrisClusterEnabled       true
Server.WaterPhysicsEnabled		  true
Server.IsDesertingAllowed		  false
Server.IsRenderDamageEvents       false
Server.IsStatsEnabled             false
Server.IsNetworkStatsEnabled      false
Server.IsAiEnabled                true
Server.AILooksIntoCamera 		  false
Server.IsDestructionEnabled       true
Server.IsTreeDestructionEnabled   true
Server.IsSoldierAnimationEnabled  true
Server.IsSoldierDetailedCollisionEnabled true
Server.DisableCutscenes           false
Server.HavokVisualDebugger        false
Server.ShowTriggerDebugText       false
Server.TimeoutGame                false
Server.TimeoutTime                9999.0 // 5.0
Server.SaveGameVersion            9
Server.ActiveLicenses             bhlc,bhlr

Server.JobEnable                  true
	
Server.ThreadedLoadingEnable      true

Server.ServerSidePatchingEnabled   false

enable-category-lookup-error-trigger false
Server.FallBackToSquadSpawn false

Server.Playlist DefaultPlayList
Server.forceCurrentMapOnLoad true
Server.forceStartMapOnLoad false
BFServer.ServerType OFFICIAL
ServerMapSequencer.DebugOutput true

Player.ignoreLevelWarmUpTimers true

Client.IsSpectator                false
#Client.ScreenshotToFile          true
Client.OccludersEnabled           true
Client.DebrisClusterEnabled       true
Client.TerrainEnabled             true
Client.WaterPhysicsEnabled        true
Client.PauseGameOnStartUp         false
Client.RenderTags                 false
Client.EffectsEnabled             true
Client.EmittersEnabled            true
Client.OnDamageSpottingEnabled    false

#Client.ServerIp                   10.20.102.99
#Client.SecondaryServerIp          10.20.102.63

Client.DrawStats  false
Client.DrawFpsStats  true
Client.DrawObjectLimits  true
Client.DrawNetworkStats false

Client.Team                       0
Client.Kit                        0

Persistence.AllUnlocksAlwaysUnlocked false

#Client.SpawnPoint
Client.InvertPitch                false
Client.InvertPadPcRightStick      false
//Flip Y-axis for non-pilots (Infantry and Land Vehicles)
Client.Scheme0FlipY				  false
//Flip Y-axis for pilots (Air Vehicles)
Client.Scheme1FlipY				  false
Client.AimScale                   1.0
Client.HavokVisualDebugger        false
Client.HavokVDBShowsEffectsWorld  false

Client.IncomingFrequency 15.0
Client.IncomingRate 160000
Client.OutgoingRate 64000

Server.OutgoingFrequency 10.0
Server.OutgoingRate 160000
Server.IncomingRate 64000

Server.HighFrequencyUpdateEnabled true
Server.HighFrequencyUpdateAllowedOnGen3 true
Server.OutgoingHighFrequencyRate 128000
Server.OutgoingHighFrequency 30

// Internet simulation start (only active in multiplayer)
Server.UseDebugSocket false
Server.OverrideRemoteInternetSimulation false
Server.AllowOverrideInternetSimulation false

Server.IncomingInternetSimulation.Enable true
Server.IncomingInternetSimulation.ReorderRatioMin 0.0
Server.IncomingInternetSimulation.ReorderRatioMax 0.0
Server.IncomingInternetSimulation.LatencyMin 0.020
Server.IncomingInternetSimulation.LatencyMax 0.100
Server.IncomingInternetSimulation.LatencyVariance 0.25
Server.IncomingInternetSimulation.DuplicateRatioMin 0.0
Server.IncomingInternetSimulation.DuplicateRatioMax 0.0
Server.IncomingInternetSimulation.DropRatioMin 0.002
Server.IncomingInternetSimulation.DropRatioMax 0.010
Server.IncomingInternetSimulation.CorruptRatioMin 0.0
Server.IncomingInternetSimulation.CorruptRatioMax 0.0
Server.IncomingInternetSimulation.SizeRatioMin 0.0
Server.IncomingInternetSimulation.SizeRatioMax 0.0
Server.IncomingInternetSimulation.SpikeDurationMin 0.0
Server.IncomingInternetSimulation.SpikeDurationMax 0.0
Server.IncomingInternetSimulation.SpikeDurationVariance 0.0
Server.IncomingInternetSimulation.SpikeCooldownMin 0.0
Server.IncomingInternetSimulation.SpikeCooldownMax 0.0
Server.IncomingInternetSimulation.SpikeCooldownVariance 0.0

Server.OutgoingInternetSimulation.Enable true
Server.OutgoingInternetSimulation.ReorderRatioMin 0.0
Server.OutgoingInternetSimulation.ReorderRatioMax 0.0
Server.OutgoingInternetSimulation.LatencyMin 0.020
Server.OutgoingInternetSimulation.LatencyMax 0.100
Server.OutgoingInternetSimulation.LatencyVariance 0.25
Server.OutgoingInternetSimulation.DuplicateRatioMin 0.0
Server.OutgoingInternetSimulation.DuplicateRatioMax 0.0
Server.OutgoingInternetSimulation.DropRatioMin 0.002
Server.OutgoingInternetSimulation.DropRatioMax 0.010
Server.OutgoingInternetSimulation.CorruptRatioMin 0.0
Server.OutgoingInternetSimulation.CorruptRatioMax 0.0
Server.OutgoingInternetSimulation.SizeRatioMin 0.0
Server.OutgoingInternetSimulation.SizeRatioMax 0.0
Server.OutgoingInternetSimulation.SpikeDurationMin 0.0
Server.OutgoingInternetSimulation.SpikeDurationMax 0.0
Server.OutgoingInternetSimulation.SpikeDurationVariance 0.0
Server.OutgoingInternetSimulation.SpikeCooldownMin 0.0
Server.OutgoingInternetSimulation.SpikeCooldownMax 0.0
Server.OutgoingInternetSimulation.SpikeCooldownVariance 0.0

Client.UseDebugSocket false
Client.OverrideRemoteInternetSimulation false
Client.AllowOverrideInternetSimulation true

Client.IncomingInternetSimulation.Enable false
Client.IncomingInternetSimulation.ReorderRatioMin 0.0
Client.IncomingInternetSimulation.ReorderRatioMax 0.0
Client.IncomingInternetSimulation.LatencyMin 0.020
Client.IncomingInternetSimulation.LatencyMax 0.100
Client.IncomingInternetSimulation.LatencyVariance 0.25
Client.IncomingInternetSimulation.DuplicateRatioMin 0.0
Client.IncomingInternetSimulation.DuplicateRatioMax 0.0
Client.IncomingInternetSimulation.DropRatioMin 0.002
Client.IncomingInternetSimulation.DropRatioMax 0.010
Client.IncomingInternetSimulation.CorruptRatioMin 0.0
Client.IncomingInternetSimulation.CorruptRatioMax 0.0
Client.IncomingInternetSimulation.SizeRatioMin 0.0
Client.IncomingInternetSimulation.SizeRatioMax 0.0
Client.IncomingInternetSimulation.SpikeDurationMin 0.0
Client.IncomingInternetSimulation.SpikeDurationMax 0.0
Client.IncomingInternetSimulation.SpikeDurationVariance 0.0
Client.IncomingInternetSimulation.SpikeCooldownMin 0.0
Client.IncomingInternetSimulation.SpikeCooldownMax 0.0
Client.IncomingInternetSimulation.SpikeCooldownVariance 0.0

Client.OutgoingInternetSimulation.Enable false
Client.OutgoingInternetSimulation.ReorderRatioMin 0.0
Client.OutgoingInternetSimulation.ReorderRatioMax 0.0
Client.OutgoingInternetSimulation.LatencyMin 0.020
Client.OutgoingInternetSimulation.LatencyMax 0.100
Client.OutgoingInternetSimulation.LatencyVariance 0.25
Client.OutgoingInternetSimulation.DuplicateRatioMin 0.0
Client.OutgoingInternetSimulation.DuplicateRatioMax 0.0
Client.OutgoingInternetSimulation.DropRatioMin 0.002
Client.OutgoingInternetSimulation.DropRatioMax 0.010
Client.OutgoingInternetSimulation.CorruptRatioMin 0.0
Client.OutgoingInternetSimulation.CorruptRatioMax 0.0
Client.OutgoingInternetSimulation.SizeRatioMin 0.0
Client.OutgoingInternetSimulation.SizeRatioMax 0.0
Client.OutgoingInternetSimulation.SpikeDurationMin 0.0
Client.OutgoingInternetSimulation.SpikeDurationMax 0.0
Client.OutgoingInternetSimulation.SpikeDurationVariance 0.0
Client.OutgoingInternetSimulation.SpikeCooldownMin 0.0
Client.OutgoingInternetSimulation.SpikeCooldownMax 0.0
Client.OutgoingInternetSimulation.SpikeCooldownVariance 0.0
// Internet simulation end


Client.ThreadedLoadingEnable      true
Client.VisualFrameInterpolation   true

Client.AsyncClientBulletEntity    true

UI.AmpServerEnabled				  false
UI.AmpWaitForServerConnection	  false
UI.AmpPort						  7534
UI.OnScreenTraces				  false
UI.OnScreenGlyphCache             false
UI.ShowDebugStringTag			  false
UI.OutputEnabled                  false
UI.VerboseOutputEnabled           false
// Language can be set to override the language that is getting sent from the web
UI.Language						  LanguageFormat_Undefined
UI.FontCacheTextureWidth		  1024
UI.FontCacheTextureHeight		  1024
UI.RenderCommandBufferSize		  327680
UI.RenderVertexBufferSize	      360448
UI.RenderIndexBufferSize	      98304
UI.RenderPcBufferScale			  4
UI.DisableMoviesOnConsoles		  true
UI.MaxMinimapIconsPc			  256
UI.MaxMinimapIconsConsole		  64

Minimap.TileFadeInSpeed			  8
Minimap.TileFadeOutSpeed		  16

Core.LogLevel                     Info
Core.EnableMemoryDump             false
Core.CrashOnFatalErrors		      true
Core.ProfileDirectoryName         Battlefield 4
Core.BugSubmitTool                BST_B4Bug
Core.InitSeed                     xa37dd45ffe100bfffcc9753aabac325f07cb3fa231144fe2e33ae4783feead2b8a73ff021fac326df0ef9753ab9cdf6573ddff0312fab0b0ff39779eaff312a4f5de65892ffee33a44569bebf21f66d22e54a22347efd375981188743afd99baacc342d88a99321235798725fedcbf43252669dade32415fee89da543bf23d4ex

Game.LogFileEnable true
Game.LogFileCollisionMode LFCM_Rotate

WaterInteract.GridCount 16

Decal.RingBufferMaxVertexCount 15000
Decal.StaticBufferMaxVertexCount 1000000
Decal.DebugWarningsEnable false

Render.DrawFpsMethod 1

DebugRender.DxMaxVertexCount 262144

//Set the Near Plane to 0.06 to help fix the most major clipping issues on weapon animations. -akertz
Render.NearPlane 0.06

Render.XenonBufferTwoFramesEnable 1

Occlusion.NormalViewDistance 400
Occlusion.TerrainViewDistance 2000
VisualTerrain.OccludedMinDistance 128

Enlighten.SpotLightShadowsEnable false

TextureStreaming.Enable 1
TextureStreaming.PoolSize 200000
TextureStreaming.OnDemandPoolSize 16000
TextureStreaming.MinTextureSize 50000

# Should really be the new default value
VisualTerrain.DecalOffsetY 0.04

//terrain crater test, DepthFactor should be 1 by default though. -mnellfors
Terrain.ModifierDepthFactor 1
Terrain.ModifierSlopeMax 0.7

TerrainStreaming.DataLoadJobCount 192

Physics.RemoveRagdollWhenWoken false
Physics.RemoveFromWorldOnCollisionOverflow false
Physics.SingleStepCharacter true
Physics.HeightfieldRSXStreaming true
#Physics.EnableClientWheelRaycasts true2

ragdoll-settle-angularvelocity 0.05
ragdoll-settle-linearvelocity 0.05
ragdoll-settle-minactivetime 5

GameAnimation.RespawnOnResourceReload false
GameAnimation.UseAnimationDrivenCharacter true
GameAnimation.TemporalLoddingFirstDistance 10000
GameAnimation.TemporalLoddingSecondDistance 10000
GameAnimation.TemporalLoddingThirdDistance 10000
GameAnimation.TemporalLoddingFourthDistance 10000
GameAnimation.TemporalLoddingFifthDistance 10000
GameAnimation.TemporalLoddingSixthDistance 10000

EmitterSystem.QuadGroupsJoinNiceAndSimple true

# Damage blood decals, conditions: !occluded, alive, !immortal, bullet dmg, dmg > 0
SoldierDecalComponent.SpawnSplashOnDamageEnabled true
SoldierDecalComponent.SpawnSplashOnDamageCooldown 3.0

# Raycasts (two atm) detecting entities around explosion (clientside only)
Explosion.SecondaryMaterialImpactRaycastsEnabled true

Audio.ReverbAllocSize 983040

BFServer.NoInteractivityTimeoutTime 300
BFServer.NoInteractivityThresholdLimit 0.1
BFServer.DefaultVoiceChannel Squad
BFServer.AlwaysAllowedToSpectate true

Game.IsGodMode                  false
Game.IsJesusMode                false
Game.useSingleWeaponSelector	true
Game.UseSpeedBasedDetailedCollision true
Game.AwardsTracking true
Game.HasUnlimitedAmmo           false
Game.HasUnlimitedMags           false
Game.AutoAimEnabled		false
Game.DifficultyIndex	  -1 // Debug difficulty index to data GameConfigurations/Game_Difficulty_Settings.dbx
//Game.DisablePreRound		true

#Don't turn this on, use the weapon data to control the FOV instead.
#SoldierRender.WeaponFovEnable	false

UI.ConstructibleList Objects/Constructibles/Constructibles
UI.BatchingEnable true
UI.MaxVertexCount 32768
UI.RenderTargetMipmapGenEnable true
UI.PostProcessSystemEnable true
UI.PostProcessEnable true
UI.PostProcessMipmapgenEnable false

UIMessageComp.debugRendering	false

UICoopComp.UnlockAllLevels	false
UILevelComp.UnlockAllSpLevels	false

Client.UseMouseAndKeyboardSystem	true
Core.EnableDbErrorPolicy true

Core.EnableJuice false
Core.JuiceServerIP               10.20.96.118
Core.JuiceLogLevel		Info
Juice.AlternativeNamingScheme true

Core.MemoryStatsEnabled	true
Memory.DrawStats true

DebugRender.TextQueueMaxLineCount 10
DebugRender.TextQueueTimeVisible 10.0
proximity-interact-distance 4.0

Occlusion.MaxTriangleCount 30000

Core.DisplayAsserts true

uiqueue-delay 10
kill-message-delay 0

Blaze.ServerAutoAccountCreation true


SoldierTest.spawnEnabled false
SoldierTest.scriptsEnabled false
controllableEntityJobsEnabled true

DisplayObjective false;
DisplayMapMarkers false;

#
# ANT settings
#

Ant.EnableJobs true

# Memory Budget Size is a pure cosmetical vars to help content creators manage the memory
antDebug.MemoryBudgetSize 20

# Vars
Ant.MaxInterpolationSlots 100
Soldier.cameraLagEffect 0
Ant.BlockOnJobs true
Ant.ClientEmulatesServer false
Ant.UseCameraFov false
Ant.UseWeaponFov false
Soldier.animate3pWhenIn1p true
Ant.InterpolatePoses true

// Allow variable length ticks to be used for console MP
Ant.AllowVariableTickLength true

Ant.ReducedInterpolationDistance 10.0
Ant.TrajectoryOnlyInterpolationDistance 100.0
Ant.CheckGiantSoldiers 0.0

Ant.LeanSignalClamp 2
Ant.LeanSignalScale 1.2


Customization.dropGearVelocityScale 0.7

Core.Heartbeat			false
Core.HeartbeatInterval	2

Core.HardwareProfile Hardware_AutoDetect

Network.TitleId 5
Network.ClientPort 25100
Network.ServerPort 25200
Network.MaxGhostCount 8192
Network.MaxClientCount 70
Network.UseFrameManager true
Network.MaxServerFrameSize 4096
//Network.MaxClientFrameSize 2048

//Network.ClientConnectionDebugFilePrefix client
//Network.ServerConnectionDebugFilePrefix server

//Demo.TimeDemo demos/perf/demo0
//Demo.PauseOnStartup true
//Demo.StartProfilingOnFrame 400
//Demo.StopProfilingOnFrame 600
//Demo.LockToPlayerName JLORD1
//Demo.ForcedDeltaTickCount 0
//Demo.RecordDemoFileName demos/perf/demo0
//Demo.PlaybackDemoFileName demos/perf/demo0

// These are still here since bumping SettingsBuilder after changing the default values didn't work.
// 70 = 64 max regular players (soldiers) + 2 commanders + 4 max spectator players
// Note that MaxPlayerCount also affects AI players in single player.
Game.MaxPlayerCount 70
Game.MaxSpectatorCount 4

Game.CurrentSKU WW
Core.AvailableLanguages *

Online.PunkBusterActivateServer true
Online.PunkBusterActivateClient true
Online.FairFightEnabled true

VeniceOnline.ServiceNameOverride null
VeniceOnline.ClientGameConfigurationOverride null

Online.ClientIsPresenceEnabled true
Online.ServerIsPresenceEnabled true
Online.Environment OnlineEnvironment_Production

Online.PingSite ams
Online.BlazeLogLevel 1
blaze-connecting-messages true

// TEMPORARY SETTINGS. NOT FOR RETAIL (but Warsaw Core X)
UIMessageComp.DisplayUnlocalizedSubtitles 1

WorldRender.ShadowmapAccumEnable 1
WorldRender.ShadowmapResolution 608
WorldRender.ShadowmapSliceCount 4
WorldRender.ShadowmapQuality 1

# Smoothness for AlphaTestSimple (mostly vegetation)
WorldRender.GBufferAlphaTestSimpleSmoothness 0.3


Enlighten.JobCount 4
Enlighten.MaxPerFrameSolveTime 3.0


DebugMenu.ToggleFreeFlying true


]=]

local platformCmd = cmdLineOption('platform')
local gamePlatform = 'win32'

if platformCmd then
	gamePlatform = platformCmd:lower()
else
	gamePlatform = platform:lower()
end

-- Protocol version configuration
if gamePlatform == 'ps3' then
	Network.ProtocolVersion = '5500'
elseif gamePlatform == 'xenon' then
	Network.ProtocolVersion = '6500'
elseif gamePlatform == 'gen4a' then
	Network.ProtocolVersion = '7500'
elseif gamePlatform == 'gen4b' then
	Network.ProtocolVersion = '8500'
else
	Network.ProtocolVersion = '4500'
end

if gamePlatform == 'win32' then
	Server.FrameHistoryTime = 0.25
else
	Server.FrameHistoryTime = 0.4
end

-- Network timeout values
if config:lower() == 'debug' or config:lower() == 'release' then
	Network.ConnectTimeout = 99999 
	Client.LoadingTimeOut = 99999
	Client.LoadedTimeOut = 99999
	Client.IngameTimeOut = 99999
	Server.IngameTimeOut = 99999
	Server.LoadingTimeOut = 99999
else
	Network.ConnectTimeout = 15
	Client.LoadingTimeOut = 15
	Client.LoadedTimeOut = 15
	Client.IngameTimeOut = 15
	Server.IngameTimeOut = 15
	Server.LoadingTimeOut = 15
end

if platform == 'Win32' then
applySettings [=[


	# enable this again once AMD 13.9 drivers are available for 3xxx and 4xxx cards
	RenderDevice.MinDriverRequired 0

	ShaderSystem.FrameMemoryBufferSize 33554432

	Client.LoadMenu 0
	Client.IgnoreClientFireRateMultiplier true
	Client.SampleInputEveryVisualFrame true

	Blaze.ClientAutoAccountCreation true

	Origin.ForceLogin true
	Origin.AutoLogin true
	
	VisualTerrain.VertexBufferHeightsEnable 0
	VisualTerrain.MeshScatteringInvisibleCellFovFactor 1
	VisualTerrain.PatchSlotCount 736
	VisualTerrain.MeshScatteringInstancesPerCellMax 4096
	
	WorldRender.DynamicEnvmapEnable 0
	WorldRender.DynamicEnvmapResolution 512

	EmitterSystem.UpdateJobEnable false
		
	# Due to differences in codecs and data sizes on Win32 compared to console this needs to be quite big
	Audio.DataManagerCacheSize 104857600
	Audio.DelayLineAllocSize 5242880

	PostProcess.SpriteDofEnable true

	WorldRender.SpotLightShadowmapEnable 1
	WorldRender.SpotLightShadowmapResolution 1024
	
	# average method instead of minimum
	Render.DrawFpsMethod 1
	
	DebrisSystem.DebrisPoolSize 4096

	Deploy.PCNavigationEnabled true

	GameTime.EnableSinglePlayerFixedTick 0
	BFServer.MaxNumSoldierCorpses 10
]=]

	local onlineEnvironment = cmdLineOption('onlineEnvironment')
	if onlineEnvironment then
		onlineEnvironment = string.lower(onlineEnvironment)
		if onlineEnvironment == "dev" then
			applySettings [=[
				Online.Environment OnlineEnvironment_Development
			]=]
		elseif onlineEnvironment == "test" then
			applySettings [=[
				Online.Environment OnlineEnvironment_Test
			]=]
		elseif onlineEnvironment == "cert" then
			applySettings [=[
				Online.Environment OnlineEnvironment_Certification
			]=]
		end
	end

	local onlineService = cmdLineOption('onlineService')
	if onlineService then
		onlineService = string.lower(onlineService)
		if onlineService ~= "default" then
			local blazeServiceName = "battlefield-4-pc-" .. onlineService

			Online.ServiceNameOverride = blazeServiceName
			VeniceOnline.ServiceNameOverride = blazeServiceName
		end
	end

	local webEndpoint = cmdLineOption('webEndpoint')
	if webEndpoint then
		webEndpoint = string.lower(webEndpoint)
		local webEndpointDomain = "https://" .. webEndpoint .. ".battlelog.com"
		if string.find(webEndpoint, ".battlelog") then
			webEndpointDomain = "https://" .. webEndpoint .. ".battlefield.com"
		end

		Online.BattlelogApiUrl = webEndpointDomain
		VeniceOnline.BattlelogApiUrl = webEndpointDomain
	end

	local webMode = commandLine:lookup("webmode")
	if webMode then
		webMode = string.lower(webMode)
	end

	if webMode == "sp" then
		applySettings [=[
			Client.SkipFastLevelLoad 1
			# HACK: Workaround until VeniceOnline settings are put in the proper DDF settings namespace
			Online.EnableSnowroller 1
			VeniceOnline.EnableSnowroller 1
			Window.Minimized 1
		]=]
	
	elseif webMode == "spoffline" then
		applySettings [=[
			Game.Level Levels/FrontEnd/FrontEnd
		]=]
	
	elseif webMode == "mp" then
		applySettings [=[
			Client.SkipFastLevelLoad 1
			# HACK: Workaround until VeniceOnline settings are put in the proper DDF settings namespace
			Online.EnableSnowroller 1
			VeniceOnline.EnableSnowroller 1
			Window.Minimized 1
		]=]

	else
		webMode = nil

		applySettings [=[
			Online.ForceOnline false
			Blaze.ForceDirectLogin false
			# Blaze.ClientAutoAccountCreation should already be set to true
		]=]
	end

	-- Common webMode options.
	if webMode then
		applySettings [=[
			Core.DisplayAsserts 0
			VeniceOnline.EnableQoS false
			Origin.Enabled true
			Origin.AutoLogin false
		]=]
	end	
end

if platform == 'Gen4a' or platform == 'Gen4b' then
applySettings [=[

	# Settings copied from UserOptions, ideally should just run the UserOptions instead

	Texture.SkipMipmapCount 0
	TextureStreaming.PoolSize 800000
	TextureStreaming.OnDemandPoolSize 16000

	TerrainStreaming.HeightfieldAtlasSampleCountXFactor 1
	TerrainStreaming.HeightfieldAtlasSampleCountYFactor 2
	TerrainStreaming.MaskAtlasSampleCountXFactor 1
	TerrainStreaming.MaskAtlasSampleCountYFactor 2
	TerrainStreaming.ColorAtlasSampleCountXFactor 1
	TerrainStreaming.ColorAtlasSampleCountYFactor 2
	VisualTerrain.TextureAtlasSampleCountXFactor 1
	VisualTerrain.TextureAtlasSampleCountYFactor 2
	VisualTerrain.TextureRenderJobCount 1
	VisualTerrain.TextureRenderJobsLaunchedPerFrameCountMax 1
	VisualTerrain.TextureSkipMipSpeed 30
	#VisualTerrain.Decal3dFarDrawDistanceScaleFactor 1.7
	VisualTerrain.TextureDirtyNodeCapacity 256
	VisualTerrain.PatchSlotCount 736

	VisualTerrain.VertexBufferHeightsEnable 0
	VisualTerrain.DxDisplacementMappingEnable 0
	VisualTerrain.DxTessellatedTriWidth 12

	VisualTerrain.MeshScatteringQualityLevel QualityLevel_High
	VisualTerrain.MeshScatteringBuildChannelCount 2
	VisualTerrain.MeshScatteringBuildChannelsLaunchedPerFrameCountMax 1
	#VisualTerrain.MeshScatteringDistanceScaleFactor 1.7
	#VisualTerrain.MeshScatteringInstancesPerCellMax 4096

	WorldRender.CullScreenAreaScale 1.75
	Mesh.GlobalLodScale 1.5
	Mesh.ShadowDistanceScale 1.5

	MeshStreaming.PoolSize 250000
	Mesh.CastSunShadowQualityLevel High
	Mesh.CastDynamicEnvmapQualityLevel High
	Mesh.CastPlanarReflectionQualityLevel High
	#VegetationSystem.UseShadowLodOffset 0
	#VegetationSystem.MaxActiveDistance 300
	#VegetationSystem.MaxPreSimsPerJob 4
	VegetationSystem.SimulationMemKbClient 4096
	#Render.EdgeModelViewDistance 100

	WorldRender.SpotLightsAsConeLightsLevel QualityLevel_Medium
	WorldRender.SpotLightShadomapLevel QualityLevel_High
	EffectSystem.EffectQualityLevel QualityLevel_High
	EmitterSystem.EmitterQualityLevel QualityLevel_High
	EmitterSystem.QuadHalfResEnable 1
	EmitterSystem.QuadMaxCount 16000
	EmitterSystem.MeshMaxCount 8000
	EmitterSystem.CollisionRayCastMaxCount 50
	EmitterSystem.ProximityPhysicsEntitiesMaxCount 20
	EmitterSystem.SkipUpdateMaxCount 2
	EmitterSystem.ScreenAreaCullingMinTotalArea 50
	EmitterSystem.ScreenAreaCullingMaxTotalArea 90
	EmitterSystem.ScreenAreaCullingMaxMultiplier 0.35

	DynamicTextureAtlas.EmitterBaseWidth 8192
	DynamicTextureAtlas.EmitterBaseHeight 8192
	DynamicTextureAtlas.EmitterBaseMipmapCount 6
	DynamicTextureAtlas.EmitterBaseSkipmipsCount 0
	DynamicTextureAtlas.EmitterNormalWidth 2048
	DynamicTextureAtlas.EmitterNormalHeight 2048
	DynamicTextureAtlas.EmitterNormalMipmapCount 4
	DynamicTextureAtlas.EmitterNormalSkipmipsCount 0

	# Shadow
	WorldRender.ShadowmapViewDistance 140
	WorldRender.ShadowmapResolution 896
	WorldRender.ShadowmapSliceCount 4
	WorldRender.ShadowmapQuality QualityLevel_Medium
	WorldRender.TransparencyShadowmapsEnable 1
	WorldRender.SpotLightShadowmapLevel QualityLevel_Medium

	WorldRender.PostProcessAntialiasingMode PostProcessAAMode_FxaaHigh
	WorldRender.MotionBlurEnable 1
	WorldRender.PlanarReflectionEnable 1
	WorldRender.DistortionEnable 1
	WorldRender.DynamicEnvmapEnable 0
	WorldRender.SkyEnvmapResolution 256
	WorldRender.DynamicEnvmapResolution 256
    
	PostProcess.DynamicAOEnable 1
	PostProcess.DynamicAOMethod DynamicAOMethod_HBAO

	# Due to differences in codecs and data sizes on Gen4 compared to Gen3 this needs to be quite big
	Audio.DataManagerCacheSize 104857600
	Audio.DelayLineAllocSize 5242880

    Audio.AudioCoreSystemJobsEnabled 1
    Audio.AudioCoreWatchDogThreadEnabled 1
    Audio.AudioCoreMiniumMixAhead 0.016
    Audio.AudioCoreTargetMixAhead 0.073

	Client.SampleInputEveryVisualFrame true

	# Allow fixing of singleplayer framerate only < 30 fps
	GameTime.EnableSinglePlayerFixedTick 1
	
	# Disable animation if smaller than this many pixels
	Ant.AutoCullPixelSize 10

	BFServer.MaxNumSoldierCorpses 10
	GameTime.DoubleNoTickWait 0

	Enlighten.LightProbeLookupTableGridRes 64
	
	BFServer.HostEjectionOnMapRotationChangeEnabled true
]=]
end

if platform == 'Gen4a' then
applySettings [=[

	# run at 720p
	Render.ResolutionScale 0.6667

	# tighten the gamepad analog stick deadzone down to 18%
	Client.Gen4aGamepadDeadZoneCenter 0.18

	]=]
end

if platform == 'Gen4b' then
applySettings [=[

	# run at 1600x900p
	Render.ResolutionScale 0.83333333

	Audio.AudioCoreMiniumMixAhead 0.032

	]=]
end


if platform == 'Ps3' or platform == 'Xenon' then
applySettings [=[

	Client.VSyncEnable 1

	Ant.MaxInterpolationSlots 32

    Audio.AudioCoreSystemJobsEnabled 1
    Audio.AudioCoreWatchDogThreadEnabled 1
    Audio.AudioCoreMiniumMixAhead 0.016
    Audio.AudioCoreTargetMixAhead 0.073

	Audio.DelayLineAllocSize 1179648

	# saves 10 mb of memory on xenon
	UI.ScreenshotEnable 0
	
	Decal.RingBufferMaxVertexCount 8192
	Decal.StaticBufferMaxVertexCount 16384
		
	MeshStreaming.MaxPendingLoadCount 2
	TextureStreaming.MaxPendingLoadCount 4
	TextureStreaming.MaxMipmapCount 13
	TextureStreaming.DefragFrameTransferLimit 1500
	
	TerrainStreaming.ActiveFreeStreamingDataLoadJobCount 1

	Network.MaxClientCount 26
	Game.MaxSpectatorCount 0


	WorldRender.SpotLightShadowmapEnable 1
	WorldRender.SpotLightShadowmapResolution 512
	WorldRender.SpotLightShadowmapLevel QualityLevel_Low

	WorldRender.PlanarReflectionEnable 0
	WorldRender.DynamicEnvmapEnable 0
	Enlighten.CubeMapsEnable 0
	
	DynamicTextureAtlas.EmitterBaseWidth 2048
	DynamicTextureAtlas.EmitterBaseHeight 2048
	DynamicTextureAtlas.EmitterBaseMipmapCount 4
	DynamicTextureAtlas.EmitterNormalWidth 128
	DynamicTextureAtlas.EmitterNormalHeight 128
	DynamicTextureAtlas.EmitterNormalMipmapCount 1
	
	VisualTerrain.LodScale 0.5
	VisualTerrain.TextureLevelOffset 2
	VisualTerrain.TextureSamplesPerMeterMax 16

	DebrisSystem.DebrisPoolSize 512

	WaterInteract.WaterQualityLevel QualityLevel_Low

	Minimap.MipBias 1.0

	GameTime.EnableSinglePlayerFixedTick 1

	# Disable animation if smaller than this many pixels
	Ant.AutoCullPixelSize 30
		
	PostProcess.IronsightsDofEnable 0

	BFServer.MaxNumSoldierCorpses 5
]=]
end

if platform == 'Ps3' then
applySettings [=[

	TextureStreaming.PoolSize 40000
	TextureStreaming.OnDemandPoolSize 2000
	MeshStreaming.PoolSize 50000
	MeshStreaming.Ps3CellPoolSize 18000

	VegetationSystem.MaxActiveDistance 100

	Occlusion.MaxTriangleCount 5000

	Audio.DataManagerCacheSize 8925184
	Audio.DataManagerCacheRsxSize 20971520
	
	# ShaderSystem.FrameMemoryBufferSize 3670016
	ShaderSystem.FrameMemoryBufferSize 5000000 

	Render.Ps3FrameLocalBufferSize 5242880 
	Render.Ps3FrameMainBufferSize 5242880
	PostProcess.Ps3EdgeMlaaEnable 1
	
	Render.Ps3Res1280x704Enable 1
	
	VisualTerrain.MeshScatteringInstanceOcclusionCullEnable 1

	EmitterSystem.UpdateJobEnable false
	EmitterSystem.ScreenAreaCullingStart 0.2
	EmitterSystem.ScreenAreaCullingEnd 1.2
]=]

	local superbundles = cmdLineOption('super')
	if not superbundles then
		applySettings [=[
		# Enable DVD emulation when running from Avalanche.
		Core.HttpDvdSimulation 1
		Core.HttpDvdSeekPenalty 120
		# Assume texture/mesh chunks are located on HDD. This disables DVD simulation seek penalties for them.
		TurboLoader.EmulateChunksOnHdd 2	
	]=]
	end
end

if platform == 'Xenon' then
applySettings [=[

	# use larger pool on Xenon due to more padding in textures caused by tile restrictions
	DestructionVolume.TexturePoolSize 524416
	DestructionVolume.TexturePoolHeadroomSize 32768

	Render.XenonRingBufferSize 2621440

	VegetationSystem.MaxActiveDistance 100

	TextureStreaming.PoolSize 65000
	TextureStreaming.OnDemandPoolSize 2000
	MeshStreaming.PoolSize 40000

	MeshStreaming.XenonFinalPoolSizeAdjustment 0
	MeshStreaming.XenonRetailPoolSizeAdjustment 0
	TextureStreaming.XenonFinalPoolSizeAdjustment 0
	TextureStreaming.XenonRetailPoolSizeAdjustment 5000

	Occlusion.MaxTriangleCount 5000

	Audio.DataManagerCacheSize 26214400

	ShaderSystem.FrameMemoryBufferSize 6000000 
	ShaderSystem.XenonDispatchCmdBufferSize 1048576

	WorldRender.FastHdrEnable true

	VisualTerrain.VertexBufferHeightsEnable 0
	
	PostProcess.LUTGammaR 1.3
	PostProcess.LUTGammaG 1.3
	PostProcess.LUTGammaB 1.3
	PostProcess.LUTGammaCurbOffset 0.1
	
]=]

	local superbundles = cmdLineOption('super')
	if superbundles then
		applySettings [=[
			#temporary disable all free streaming on xbox until the hd install flow is finished, that way we can still create the hd superbundle and thus make sure to fit on disc
			#Game.ForceDisableFreeStreaming true
		]=]
	else
		applySettings [=[
			# Enable DVD emulation when running from Avalanche.
			Core.HttpDvdSimulation 1
			Core.HttpDvdSeekPenalty 120
			# Assume texture/mesh chunks are located on HDD. This disables DVD simulation seek penalties for them.
			TurboLoader.EmulateChunksOnHdd 2	
		]=]
	end
end


local level = cmdLineOption('level')
if level then
	log:debug("Level specified on commandline, enabling fast startup")

	-- Level names without slashes are assumed to be shorthand for
	-- Levels/name/name to go with Venice's epic level naming convention
	if not string.find(level, "/") then
		level = "Levels/" .. level .. "/" .. level
	end

	Game.Level = level
end

local dedicatedServer = cmdLineOption('dedicated')
if dedicatedServer then
	if gamePlatform == 'win32' then
		applySettings [=[
			LiveServerProxy.Enabled true
		]=]
	end
	if gamePlatform == 'ps3' or gamePlatform == 'xenon' then
		applySettings [=[
			Network.MaxClientCount 26
			Game.MaxSpectatorCount 0
		]=]
	end
	applySettings [=[
		Server.ThreadingEnable false
		Ant.EnableJobs false
		GameAnimation.ServerEnable false

		ServerMetrics.Enabled false
		ServerMetrics.TransactionTelemetryEnabled true

		ServerMetrics.PerformanceTelemetryEnabled true
		ServerMetrics.PerformanceProfileStateEnabled true
	]=]
	
	local level = cmdLineOption('level')
	if not level then
		applySettings [=[
		#HACK: We need to set a level that always exists on the server, unfortunatley there is no such level so we just pick MP_Siege...z
		Game.Level Levels/MP/MP_Siege/MP_Siege
		Game.DefaultLayerInclusion GameMode=ConquestSmall0
	]=]
	end

	local protocolVersionCmd = cmdLineOption('protocolVersion')
	if protocolVersionCmd then
		Network.ProtocolVersion = protocolVersionCmd
	end
end

local battlelog = cmdLineOption('battlelogURL')
if battlelog then
	Online.BattlelogReportURL = battlelog
	VeniceOnline.BattlelogReportURL = battlelog
end

local startPoint = cmdLineOption('startpoint')
if startPoint then
	Game.StartPoint = startPoint
end

if Game.StartPoint and (string.find(Game.StartPoint, "E3_") or string.find(Game.StartPoint, "E3 ")) then
	applySettings [=[
		VeniceUI.PlatformOverride xenon
		Vehicle.UpsideDownDamage false
	]=]
end